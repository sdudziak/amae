services:
  db:
    image: mariadb:11
    container_name: ${PROJECT_NAME}-db
    environment:
      MYSQL_DATABASE: ${WP_DB_NAME}
      MYSQL_USER: ${WP_DB_USER}
      MYSQL_PASSWORD: ${WP_DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${WP_DB_ROOT_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mariadb-admin ping -uroot -p$${MYSQL_ROOT_PASSWORD} -h 127.0.0.1 --silent"]
      interval: 10s
      timeout: 5s
      retries: 10

  wordpress:
    image: wordpress:6.8.2-php8.2-fpm
    container_name: ${PROJECT_NAME}-wp
    depends_on:
      db:
        condition: service_healthy
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_NAME: ${WP_DB_NAME}
      WORDPRESS_DB_USER: ${WP_DB_USER}
      WORDPRESS_DB_PASSWORD: ${WP_DB_PASSWORD}
      WORDPRESS_TABLE_PREFIX: ${WP_TABLE_PREFIX}
      WP_ENVIRONMENT_TYPE: local
      WORDPRESS_CONFIG_EXTRA: |
        // Hardening & dev logs
        define('DISALLOW_FILE_EDIT', true);
        define('WP_DEBUG', true);
        define('WP_DEBUG_LOG', true);
        define('WP_MEMORY_LIMIT', '256M');
        // Absolute path to protected files (non-webroot)
        if (!defined('PROTECTED_PATH')) { define('PROTECTED_PATH', '/var/www/protected'); }
    # Kluczowe: bind-mount do katalogu w WSL (szybki)
    volumes:
      - ./bedrock/web:/var/www/html
    # (Opcjonalnie) uruchamiaj jako Twój UID/GID 1000, żeby pliki tworzyły się z Twoją własnością:
    user: "1000:1000"

  nginx:
    image: nginx:1.27-alpine
    container_name: ${PROJECT_NAME}-nginx
    depends_on:
      - wordpress
    ports:
      - "8080:80"
    volumes:
      - ./bedrock/web:/var/www/html:ro
      - ./ops/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro

  phpmyadmin:
    image: phpmyadmin:5
    container_name: ${PROJECT_NAME}-pma
    depends_on:
      - db
    ports:
      - "8081:80"
    environment:
      PMA_HOST: db
      PMA_USER: ${WP_DB_USER}
      PMA_PASSWORD: ${WP_DB_PASSWORD}

  wpcli:
    image: wordpress:cli-php8.2
    user: "1000:1000"
    depends_on:
      db:
        condition: service_healthy
      wordpress:
        condition: service_started
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_NAME: ${WP_DB_NAME}
      WORDPRESS_DB_USER: ${WP_DB_USER}
      WORDPRESS_DB_PASSWORD: ${WP_DB_PASSWORD}
      HOME: /tmp
      WP_CLI_CACHE_DIR: /tmp/wp-cli-cache
    volumes:
      - ./bedrock/web:/var/www/html
    entrypoint: ["wp","--path=/var/www/html","--allow-root"]
    tmpfs:
      - /tmp

volumes:
  db_data:
